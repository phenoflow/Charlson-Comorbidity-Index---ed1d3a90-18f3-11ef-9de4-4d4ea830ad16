# Caroline Fairhust, Fabiola Martin, Ian Watt, Tim Doran, Martin Bland, William J Brackenbury, 2024.

import sys, csv, re

codes = [{"code":"C109412","system":"readv2"},{"code":"F372200","system":"readv2"},{"code":"C108100","system":"readv2"},{"code":"C10FA11","system":"readv2"},{"code":"F381311","system":"readv2"},{"code":"C108200","system":"readv2"},{"code":"C10E500","system":"readv2"},{"code":"F372.12","system":"readv2"},{"code":"C106.12","system":"readv2"},{"code":"2G5V.00","system":"readv2"},{"code":"2BBW.00","system":"readv2"},{"code":"C109A11","system":"readv2"},{"code":"66Al.00","system":"readv2"},{"code":"C10F200","system":"readv2"},{"code":"C108D00","system":"readv2"},{"code":"C10z.00","system":"readv2"},{"code":"C10FH00","system":"readv2"},{"code":"C10E111","system":"readv2"},{"code":"C10F211","system":"readv2"},{"code":"C10FB00","system":"readv2"},{"code":"C10E600","system":"readv2"},{"code":"C10FM11","system":"readv2"},{"code":"C10E700","system":"readv2"},{"code":"2BBX.00","system":"readv2"},{"code":"C10E112","system":"readv2"},{"code":"C109H12","system":"readv2"},{"code":"C109B00","system":"readv2"},{"code":"2G5F.00","system":"readv2"},{"code":"C109C11","system":"readv2"},{"code":"2G5G.00","system":"readv2"},{"code":"C107.12","system":"readv2"},{"code":"C10E000","system":"readv2"},{"code":"Cyu2300","system":"readv2"},{"code":"C10EP11","system":"readv2"},{"code":"C109A00","system":"readv2"},{"code":"C109111","system":"readv2"},{"code":"C109511","system":"readv2"},{"code":"F420200","system":"readv2"},{"code":"C106100","system":"readv2"},{"code":"C109211","system":"readv2"},{"code":"C108512","system":"readv2"},{"code":"C109300","system":"readv2"},{"code":"C10EC00","system":"readv2"},{"code":"C108212","system":"readv2"},{"code":"C104z00","system":"readv2"},{"code":"2BBS.00","system":"readv2"},{"code":"C10EQ00","system":"readv2"},{"code":"C10FC00","system":"readv2"},{"code":"C106.00","system":"readv2"},{"code":"C108J12","system":"readv2"},{"code":"C109212","system":"readv2"},{"code":"C109E11","system":"readv2"},{"code":"C108700","system":"readv2"},{"code":"C109G00","system":"readv2"},{"code":"C10F311","system":"readv2"},{"code":"C109G11","system":"readv2"},{"code":"C107z00","system":"readv2"},{"code":"C106.11","system":"readv2"},{"code":"C108711","system":"readv2"},{"code":"C107400","system":"readv2"},{"code":"C108C00","system":"readv2"},{"code":"R054300","system":"readv2"},{"code":"2G5B.00","system":"readv2"},{"code":"2G5W.00","system":"readv2"},{"code":"C10E711","system":"readv2"},{"code":"F420600","system":"readv2"},{"code":"2BBL.00","system":"readv2"},{"code":"C108D11","system":"readv2"},{"code":"C10FA00","system":"readv2"},{"code":"C108300","system":"readv2"},{"code":"2G5A.00","system":"readv2"},{"code":"F420800","system":"readv2"},{"code":"C10FB11","system":"readv2"},{"code":"C10FL11","system":"readv2"},{"code":"C107100","system":"readv2"},{"code":"F372.00","system":"readv2"},{"code":"C105000","system":"readv2"},{"code":"C106000","system":"readv2"},{"code":"C109000","system":"readv2"},{"code":"C106z00","system":"readv2"},{"code":"C107200","system":"readv2"},{"code":"C109F11","system":"readv2"},{"code":"C108H00","system":"readv2"},{"code":"2G5K.00","system":"readv2"},{"code":"C108H11","system":"readv2"},{"code":"F420400","system":"readv2"},{"code":"C109512","system":"readv2"},{"code":"C10EC11","system":"readv2"},{"code":"2BBP.00","system":"readv2"},{"code":"C108211","system":"readv2"},{"code":"C104.11","system":"readv2"},{"code":"C10F600","system":"readv2"},{"code":"C108012","system":"readv2"},{"code":"C104.00","system":"readv2"},{"code":"C109H11","system":"readv2"},{"code":"C107000","system":"readv2"},{"code":"C109400","system":"readv2"},{"code":"7276.00","system":"readv2"},{"code":"C108500","system":"readv2"},{"code":"C109E00","system":"readv2"},{"code":"C10EC12","system":"readv2"},{"code":"C108J00","system":"readv2"},{"code":"C10FM00","system":"readv2"},{"code":"C109C00","system":"readv2"},{"code":"C108712","system":"readv2"},{"code":"F420100","system":"readv2"},{"code":"C10F911","system":"readv2"},{"code":"C10E712","system":"readv2"},{"code":"C10FQ00","system":"readv2"},{"code":"2BBQ.00","system":"readv2"},{"code":"F420.00","system":"readv2"},{"code":"C10F500","system":"readv2"},{"code":"C108000","system":"readv2"},{"code":"C10EF00","system":"readv2"},{"code":"C10A500","system":"readv2"},{"code":"2G51000","system":"readv2"},{"code":"C10EJ00","system":"readv2"},{"code":"C10zz00","system":"readv2"},{"code":"C104100","system":"readv2"},{"code":"C105y00","system":"readv2"},{"code":"C106.13","system":"readv2"},{"code":"C109612","system":"readv2"},{"code":"C108B11","system":"readv2"},{"code":"C10F411","system":"readv2"},{"code":"C105z00","system":"readv2"},{"code":"2BBR.00","system":"readv2"},{"code":"C109E12","system":"readv2"},{"code":"C108z00","system":"readv2"},{"code":"C10FE11","system":"readv2"},{"code":"2BBF.00","system":"readv2"},{"code":"C10z100","system":"readv2"},{"code":"C109F00","system":"readv2"},{"code":"C108G00","system":"readv2"},{"code":"C10F111","system":"readv2"},{"code":"F372100","system":"readv2"},{"code":"C10EB00","system":"readv2"},{"code":"C10E511","system":"readv2"},{"code":"F464000","system":"readv2"},{"code":"C108y00","system":"readv2"},{"code":"C104y00","system":"readv2"},{"code":"C109600","system":"readv2"},{"code":"C10EF12","system":"readv2"},{"code":"G73y000","system":"readv2"},{"code":"C107.00","system":"readv2"},{"code":"C10EL00","system":"readv2"},{"code":"C10F100","system":"readv2"},{"code":"C10EH00","system":"readv2"},{"code":"C10E512","system":"readv2"},{"code":"C109F12","system":"readv2"},{"code":"F420000","system":"readv2"},{"code":"C10F011","system":"readv2"},{"code":"C10FF00","system":"readv2"},{"code":"C10F611","system":"readv2"},{"code":"2G5E.00","system":"readv2"},{"code":"C107.11","system":"readv2"},{"code":"2832.00","system":"readv2"},{"code":"C10yz00","system":"readv2"},{"code":"C10E300","system":"readv2"},{"code":"C10FE00","system":"readv2"},{"code":"C10EG00","system":"readv2"},{"code":"C10y100","system":"readv2"},{"code":"2BBo.00","system":"readv2"},{"code":"C105100","system":"readv2"},{"code":"C109011","system":"readv2"},{"code":"C105.00","system":"readv2"},{"code":"F3y0.00","system":"readv2"},{"code":"C10z000","system":"readv2"},{"code":"C10F300","system":"readv2"},{"code":"F420300","system":"readv2"},{"code":"C109H00","system":"readv2"},{"code":"C10FG00","system":"readv2"},{"code":"C108511","system":"readv2"},{"code":"2BBV.00","system":"readv2"},{"code":"F372000","system":"readv2"},{"code":"C106y00","system":"readv2"},{"code":"C10EK00","system":"readv2"},{"code":"C107300","system":"readv2"},{"code":"2BBT.00","system":"readv2"},{"code":"C108F00","system":"readv2"},{"code":"C109G12","system":"readv2"},{"code":"C10F000","system":"readv2"},{"code":"2BBk.00","system":"readv2"},{"code":"C108600","system":"readv2"},{"code":"C104000","system":"readv2"},{"code":"2G5I.00","system":"readv2"},{"code":"C108F11","system":"readv2"},{"code":"C10y.00","system":"readv2"},{"code":"C10yy00","system":"readv2"},{"code":"C109C12","system":"readv2"},{"code":"C10EP00","system":"readv2"},{"code":"2G5H.00","system":"readv2"},{"code":"C10F800","system":"readv2"},{"code":"F420500","system":"readv2"},{"code":"C10FR00","system":"readv2"},{"code":"C10E312","system":"readv2"},{"code":"2BBl.00","system":"readv2"},{"code":"C10E100","system":"readv2"},{"code":"C108011","system":"readv2"},{"code":"C10F900","system":"readv2"},{"code":"C10E200","system":"readv2"},{"code":"F420700","system":"readv2"},{"code":"C10F811","system":"readv2"},{"code":"C109B11","system":"readv2"},{"code":"F372.11","system":"readv2"},{"code":"C108J11","system":"readv2"},{"code":"C10E311","system":"readv2"},{"code":"C109611","system":"readv2"},{"code":"2G5C.00","system":"readv2"},{"code":"2G5L.00","system":"readv2"},{"code":"R054200","system":"readv2"},{"code":"C109411","system":"readv2"},{"code":"C10F400","system":"readv2"},{"code":"C109112","system":"readv2"},{"code":"C109012","system":"readv2"},{"code":"C109100","system":"readv2"},{"code":"C109500","system":"readv2"},{"code":"F420z00","system":"readv2"},{"code":"C108B00","system":"readv2"},{"code":"C10FL00","system":"readv2"},{"code":"C10zy00","system":"readv2"},{"code":"2G5J.00","system":"readv2"},{"code":"C10ED00","system":"readv2"},{"code":"C109200","system":"readv2"}];
REQUIRED_CODES = 1;
with open(sys.argv[1], 'r') as file_in, open('charlson-comorbidity-index-potential-cases.csv', 'w', newline='') as file_out:
    csv_reader = csv.DictReader(file_in)
    csv_writer = csv.DictWriter(file_out, csv_reader.fieldnames + ["charlson-comorbidity-index-complication---primary-identified"])
    csv_writer.writeheader();
    codes_identified = 0;
    for row in csv_reader:
        newRow = row.copy();
        for cell in row:
            # Iterate cell lists (e.g. codes)
            for item in re.findall(r'\(([^,]*)\,', row[cell]):
                if(item in list(map(lambda code: code['code'], codes))): codes_identified+=1;
                if(codes_identified>=REQUIRED_CODES):
                    newRow["charlson-comorbidity-index-complication---primary-identified"] = "CASE";
                    break;
            if(codes_identified>=REQUIRED_CODES): break;
        if(codes_identified<REQUIRED_CODES):
            newRow["charlson-comorbidity-index-complication---primary-identified"] = "UNK";
        codes_identified=0;
        csv_writer.writerow(newRow)
